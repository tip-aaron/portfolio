---
import MainLayout from "@/layouts/MainLayout.astro";

import { getCollection } from "astro:content";

const certifications = (await getCollection("certifications"))
  .filter((item) => !item.data.draft)
  .sort((a, b) => b.data.publishedOn.getTime() - a.data.publishedOn.getTime());
---

<MainLayout>
  <h1>Certifications</h1>
  <div class="loader">
    <svg
      width="24"
      height="24"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
      ><circle cx="4" cy="12" r="3"
        ><animate
          id="spinner_qFRN"
          begin="0;spinner_OcgL.end+0.25s"
          attributeName="cy"
          calcMode="spline"
          dur="0.6s"
          values="12;6;12"
          keySplines=".33,.66,.66,1;.33,0,.66,.33"></animate></circle
      ><circle cx="12" cy="12" r="3"
        ><animate
          begin="spinner_qFRN.begin+0.1s"
          attributeName="cy"
          calcMode="spline"
          dur="0.6s"
          values="12;6;12"
          keySplines=".33,.66,.66,1;.33,0,.66,.33"></animate></circle
      ><circle cx="20" cy="12" r="3"
        ><animate
          id="spinner_OcgL"
          begin="spinner_qFRN.begin+0.2s"
          attributeName="cy"
          calcMode="spline"
          dur="0.6s"
          values="12;6;12"
          keySplines=".33,.66,.66,1;.33,0,.66,.33"></animate></circle
      ></svg
    >
    Loading... Please wait
  </div>
  <ul id="grid">
    {
      certifications.map(({ data }) => {
        return (
          <li class="grid-item">
            <img
              loading="lazy"
              decoding="async"
              src={data.image}
              alt={data.title}
            />

            <div class="content">
              <div class="h5">{data.title}</div>
              {data.description && <p>{data.description}</p>}
              <a
                class="link"
                href={data.link}
                target="_blank"
                rel="noopener noreferrer"
              >
                <div>View Certification</div>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 16 16"
                  fill="currentColor"
                  class="size-4"
                >
                  <path
                    fill-rule="evenodd"
                    d="M4.22 11.78a.75.75 0 0 1 0-1.06L9.44 5.5H5.75a.75.75 0 0 1 0-1.5h5.5a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0V6.56l-5.22 5.22a.75.75 0 0 1-1.06 0Z"
                    clip-rule="evenodd"
                  />
                </svg>
              </a>
            </div>
          </li>
        );
      })
    }
  </ul>
</MainLayout>

<script>
  import imagesLoaded from "imagesloaded";
  import Masonry from "masonry-layout";

  let masonry: Masonry | undefined;

  function initMasonry() {
    const grid = document.getElementById("grid");

    if (!grid) {
      // This means that we are not on the page
      // where the masonry grid is present,
      // since we are using the View
      // Transitions API. Thus, we
      // are rerunning this function on
      // every page load. Refer to the
      // event listener of "asto:page-load"
      // below
      return;
    }

    masonry = new Masonry(grid, {
      itemSelector: ".grid-item",
      columnWidth: ".grid-item",
      fitWidth: true,
      gutter: 25,
      stagger: 0,
      initLayout: false,
      transitionDuration: "0ms",
    });

    if (masonry) {
      masonry.once?.("layoutComplete", (items: any[]) => {
        // @ts-ignore
        document.querySelector(".loader")!.setAttribute("aria-hidden", "true");
        items.forEach((item) => {
          item.element.setAttribute("data-finished", "true");
        });
      });

      if (masonry) {
        imagesLoaded(grid, () => {
          masonry?.layout?.();
        });
      }
    }
  }

  document.addEventListener("astro:after-swap", () => {
    if (masonry) {
      masonry.destroy?.();
      masonry = undefined;
    }
  });

  document.addEventListener("astro:page-load", initMasonry);
</script>

<style>
  h1 {
    text-align: center;
  }

  ul {
    width: 100%;

    gap: 25px;

    margin-inline: auto;

    display: flex;
    flex-wrap: wrap;
    justify-content: center;
  }

  ul,
  li,
  .loader {
    transition:
      opacity 0.25s ease,
      visibility 0.25s ease;
    will-change: opacity, visibility;
  }

  .loader {
    transition:
      opacity 0.25s ease,
      visibility 0.25s ease,
      display 0.25 ease;
    will-change: opacity, visibility, display;
  }

  .loader {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;

    transition-behavior: allow-discrete; /* Enable discrete transitions */

    gap: 0.25rem;
  }

  .loader[aria-hidden="true"] {
    opacity: 0;
    visibility: hidden;
    display: none;

    display: none;
  }

  li a {
    margin-top: 0.75em;
  }

  li {
    width: 90vw;
    opacity: 0;
    visibility: hidden;

    margin-inline: auto;
    margin-bottom: 25px;

    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  @media only screen and (min-width: 769px) {
    li {
      width: 20rem;
    }
  }

  @media only screen and (min-width: 869px) {
    li {
      width: 25rem;
    }
  }

  li[data-finished="true"] {
    opacity: 1;
    visibility: visible;
  }
</style>
